## ClusterPediaå¼€å‘ç¯å¢ƒæ­å»º

è¯´æ˜ï¼šè¯¥ç¯å¢ƒä½¿ç”¨kindä¸ºk8sç¯å¢ƒï¼Œè¯¥kindåªæ˜¯ä¸ºäº†æ­å»ºä¸€ä¸ª k8sç¯å¢ƒï¼Œå¹¶ä¸”clustersynchro-manageråŒæ­¥è¯¥é›†ç¾¤ä¸­çš„èµ„æºï¼Œå¹¶ä¸æ˜¯è®©å…¶ä½œä¸ºClusterPediaçš„ApiServerçš„å…¥å£ã€‚ClusterPediaçš„ApiServerä¸ºæœ¬åœ°è¿è¡Œï¼Œæœ¬åœ°è°ƒè¯•ã€‚åˆ›å»ºçš„è¯ä¹¦éƒ½æ˜¯ç»™ClusterPediaçš„ApiServerä½¿ç”¨çš„ï¼Œæš‚æ—¶è·Ÿk8sçš„ApiServeræ²¡æœ‰å…³ç³»ã€‚



### 1ã€è¯ä¹¦å‡†å¤‡

> ä¸ºClusterPediaå‡†å¤‡è¯ä¹¦

è¯ä¹¦ç”Ÿæˆè‡³clusterpedia/binç›®å½•ä¸‹ï¼Œæ–¹ä¾¿åç»­è°ƒè¯•

**åˆ›shellå»º CA**

```shell
openssl req -nodes -new -x509 -keyout ca.key -out ca.crt
```

**åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦**

```shell
openssl req -out client.csr -new -newkey rsa:4096 -nodes -keyout client.key -subj "/CN=development/O=system:masters"
```

**ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦**

```shell
openssl x509 -req -days 365 -in client.csr -CA ca.crt -CAkey ca.key -set_serial 01 -sha256 -out client.crt
```

**æ‰“åŒ…å®¢æˆ·ç«¯è¯ä¹¦ä¸º p12 è¯ä¹¦**

```shell
openssl pkcs12 -export -in ./client.crt -inkey ./client.key -out client.p12 -passout pass:password
```

### 2ã€å‡†å¤‡æ•°æ®åº“

æœ¬åœ°æµ‹è¯•çš„è¯ï¼Œå¯ä»¥ç”¨ SQLite æ¥ä½œä¸ºæ•°æ®æŒä¹…åŒ–ï¼šClusterPediaçš„ApiServeræˆ–è€…clustersynchro-managerä¼šæ ¹æ®é…ç½®è‡ªå·±åˆ›å»ºä¸€ä¸ªtest.dbçš„SQLiteçš„æ•°æ®åº“ï¼Œå¹¶åˆ›å»ºå¥½è¡¨ç»“æ„ï¼Œæ— éœ€é¢å¤–å•ç‹¬å¤„ç†ã€‚

> sqlite.yaml

```yaml
type: sqlite
dsn: file:test.db
lg:
  stdout: true
  color: true
  slowThreshold: 100ms
```

ä¹Ÿå¯ä»¥ä½¿ç”¨mysqlï¼šmysqléœ€è¦æä¾›æ•°æ®åº“ã€‚ClusterPediaçš„ApiServeræˆ–è€…clustersynchro-managerä¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºè¡¨ç»“æ„ã€‚Infoçº§åˆ«è¾“å‡ºæ§åˆ¶å°æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•

> mysql.yaml

```yaml
type: "mysql"
host: "æ•°æ®åº“çš„åŸŸåæˆ–è€…IP"
port: 3306
user: root
password: "æ•°æ®åº“å¯†ç "
database: "clusterpedia"
log:
  stdout: true
  colorful: true
  slowThreshold: "100ms"
  level: Info
```

### 3ã€ä½¿ç”¨ kind åˆ›å»ºæµ‹è¯•ç”¨çš„é›†ç¾¤

> è¯¥kindåªæ˜¯ä¸ºäº†æ­å»ºä¸€ä¸ª k8sç¯å¢ƒï¼Œå¹¶ä¸”clustersynchro-manageråŒæ­¥è¯¥é›†ç¾¤ä¸­çš„èµ„æºï¼Œå¹¶ä¸æ˜¯è®©å…¶ä½œä¸ºClusterPediaçš„ApiServerçš„å…¥å£

æ ¹æ®äº‹æƒ…æƒ…å†µæ­å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç°æˆçš„k8sé›†ç¾¤

```yaml
kind create cluster
```

**éƒ¨ç½²ä¸€ä¸ª Hello World å·¥ä½œè´Ÿè½½æ–¹ä¾¿ä¹‹åæµ‹è¯•**

é›†ç¾¤ä¸­æœ‰èµ„æºæ–¹ä¾¿æµ‹è¯•å³å¯ï¼šDeploymentã€Podã€Serviceç­‰

```shell
kubectl create deployment hello-node --image=registry.k8s.io/e2e-test-images/agnhost:2.39 -- /agnhost netexec --http-port=8080
```

### 4ã€éƒ¨ç½²ClusterPediaçš„å¿…è¦èµ„æº

```shell
kubectl apply -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/deploy/clusterpedia_namespace.yaml
```

```shell
kubectl apply -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/kustomize/crds/cluster.clusterpedia.io_clustersyncresources.yaml
```

```shell
kubectl apply -f https://raw.githubusercontent.com/clusterpedia-io/clusterpedia/main/kustomize/crds/cluster.clusterpedia.io_pediaclusters.yaml
```

### 5ã€è°ƒè¯•clustersynchro-manager

è°ƒè¯•è¿è¡ŒApiServerä»£ç ï¼šclusterpedia/cmd/clustersynchro-manager/main.goè¿è¡Œå‚æ•°å¦‚ä¸‹ï¼š

å¦‚æœæ˜¯mysqlï¼Œåˆ™--storage-config mysql.yaml

```shell
./bin/clustersynchro-manager \
	--storage-config=./sqlite.yaml \
	--kubeconfig ~/.kube/config \
	--feature-gates="AllowSyncAllCustomResources=true"
```

VSCodeçš„å‚æ•°ï¼š

â€‹		ä½¿ç”¨å®Œæ•´è·¯å¾„æ˜¯å› ä¸ºï¼Œæœ‰æ—¶å€™æ— æ³•è¯†åˆ«ç›¸å¯¹è·¯å¾„

â€‹		æ–‡ä»¶è¾“å‡ºè‡³binç›®å½•

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Launch Package",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${fileDirname}",
            "output": "${workspaceFolder}/bin/clustersynchro-manager",
            "cwd": "${workspaceFolder}/bin",
            "args":[
                "--storage-config","${workspaceFolder}/bin/sqlite.yaml",
                "--kubeconfig","/root/.kube/config",
                "--feature-gates", "AllowSyncAllCustomResources=true"
            ]
        }
    ]
}
```

### 6ã€éƒ¨ç½²PediaClusterå¯¹è±¡ï¼ŒåŒæ­¥æ•°æ®

> cluster-example.yaml

```yaml
apiVersion: cluster.clusterpedia.io/v1alpha2
kind: PediaCluster
metadata:
  name: cluster-example
spec:
  apiserver: https://localhost:8443
  kubeconfig: # ä½¿ç”¨å‘½ä»¤å¾—åˆ°çš„ç»“æœï¼šcat /root/.kube/config | base64 -w 0
  syncResources:
  - group: apps
    resources:
    - deployments
```

```shell
kubectl apply -f cluster-example.yaml
```

### 7ã€è°ƒè¯•ApiServer

#### 7.1 è°ƒè¯•è¿è¡ŒApiServerä»£ç 

clusterpedia/cmd/apiserver/main.goè¿è¡Œå‚æ•°å¦‚ä¸‹ï¼š

å¦‚æœæ˜¯mysqlï¼Œåˆ™--storage-config mysql.yaml

```shell
./bin/apiserver \
	--secure-port 8443 \
	--storage-config sqlite.yaml \
	--v=7 \
	--client-ca-file ca.crt \
	--kubeconfig ~/.kube/config \
	--authentication-kubeconfig ~/.kube/config \
	--authorization-kubeconfig ~/.kube/config
```

VSCodeçš„å‚æ•°

â€‹		ä½¿ç”¨å®Œæ•´è·¯å¾„æ˜¯å› ä¸ºï¼Œæœ‰æ—¶å€™æ— æ³•è¯†åˆ«ç›¸å¯¹è·¯å¾„

â€‹		ApiServerè·Ÿclustersynchro-manageréƒ½åœ¨binç›®å½•ä¸‹ï¼Œæ–¹ä¾¿å…±ç”¨caè¯ä¹¦å’Œæ•°æ®é…ç½®ã€SQLiteçš„test.dbç­‰æ•°æ®ã€‚

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Launch Package",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${fileDirname}",
            "output": "${workspaceFolder}/bin/apiserver",
            "cwd": "${workspaceFolder}/bin",
            "args":[
                "--bind-address", "0.0.0.0",
                "--secure-port","8443",
                "--storage-config","${workspaceFolder}/bin/sqlite.yaml",
                "--v","7",
                "--client-ca-file","${workspaceFolder}/bin/ca.crt",
                "--kubeconfig","/root/.kube/config",
                "--authentication-kubeconfig","/root/.kube/config",
                "--authorization-kubeconfig","/root/.kube/config"
            ]
        }
    ]
}
```

#### 7.2 ä½¿ç”¨curl å°è¯•è°ƒç”¨ä¸€ä¸‹æ¥å£çœ‹çœ‹æ˜¯å¦æ­£å¸¸

```shell
curl -fv -k --cert-type P12 --cert client.p12:password \
   https://localhost:8443/apis/clusterpedia.io/v1beta1/resources/version
```

æˆåŠŸçš„ç»“æœ

```shell
â¯ curl  -k --cert-type P12 --cert client.p12:password \
   https://localhost:8443/apis/clusterpedia.io/v1beta1/resources/version
{
  "major": "",
  "minor": "",
  "gitVersion": "v0.0.0-master+$Format:%H$",
  "gitCommit": "$Format:%H$",
  "gitTreeState": "",
  "buildDate": "1970-01-01T00:00:00Z",
  "goVersion": "go1.20.11",
  "compiler": "gc",
  "platform": "darwin/arm64"
}%
```

**æŸ¥è¯¢Deployementæ•°æ®**

```shell
curl -fv -k --cert-type P12 --cert client.p12:password \
   https://localhost:8443/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments
```

**é—®é¢˜**

æè¿°ï¼š

```shell
resources.clusterpedia.io \"apis\" is forbidden: User \"system:anonymous\" cannot get resource \"resources/apps\" in API group \"clusterpedia.io\" at the cluster scope
```

åŸå› ï¼š

> è¯ä¹¦é—®é¢˜ï¼Œclient.p12æˆ–è€…ä½¿ç”¨çš„key.pem/cert.pemä¸æ­£ç¡®ï¼Œæˆ–è€…æœªé…ç½®è¯ä¹¦ã€‚

è§£å†³ï¼šä½¿ç”¨æ­£ç¡®çš„è¯ä¹¦ï¼Œæˆ–è€…ä½¿ç”¨tokenæ–¹å¼è®¿é—®ã€‚

#### 7.3 Postmanæµ‹è¯•

åœ¨ macOS ä¸Šçš„ Postman è¿›è¡Œè¿™æ ·çš„é…ç½®çš„æ—¶å€™ï¼Œé¦–å…ˆåœ¨èœå•æ ä¸­çš„ Postman ä¸­ç‚¹é€‰ã€ŒSettings...ï¼ˆè®¾ç½®...ï¼‰ã€æ¥æ‰“å¼€è®¾ç½®ç•Œé¢ã€‚

ç„¶ååœ¨å¦‚ä¸‹å›¾æ‰€ç¤ºçš„é…ç½®ç•Œé¢ä¸­çš„å·¦ä¾§æ‰¾åˆ°ã€ŒCertificatesï¼ˆè¯ä¹¦ï¼‰ã€ï¼Œç‚¹é€‰ååœ¨å³æ‰‹ä¾§çš„ã€ŒClient cetificatesï¼ˆå®¢æˆ·ç«¯è¯ä¹¦ï¼‰ã€éƒ¨åˆ†ä¸­ç‚¹é€‰ã€ŒAdd Certificate...ï¼ˆæ·»åŠ è¯ä¹¦...ï¼‰ã€æ¥é…ç½®è¯ä¹¦ã€‚

![image-20231231011524193](E:\WWW\dev-deploy\kubernetes\clustrepedia\å¼€å‘ç¯å¢ƒæ­å»º.assets\image-20231231011524193.png)

æ¥ä¸‹æ¥å¡«å†™å‚æ•°ï¼š

- Host éœ€è¦å¡«å†™æˆ‘ä»¬å¼€å‘å’Œæµ‹è¯•çš„æ—¶å€™ Clusterpedia `apiserver` æ‰€åœ¨çš„ IPï¼Œæœ¬åœ°å¼€å‘æµ‹è¯•çš„è¯å¡«å†™ `localhsot` å°±å¥½äº†ï¼Œç«¯å£å¡«å†™æˆ‘ä»¬ä¸Šä¸€æ­¥å¯åŠ¨ `apiserver` çš„æ—¶å€™ä¼ é€’çš„å‚æ•° `--secure-port 8443` çš„ `8443` ä½œä¸ºç«¯å£å·ã€‚
- PFX File éœ€è¦ç‚¹é€‰å¹¶é€‰ä¸­æˆ‘ä»¬ç”Ÿæˆçš„ `client.p12` è¯ä¹¦æ–‡ä»¶
- Passphrase éœ€è¦å¡«å†™æˆ‘ä»¬åœ¨[å‡†å¤‡ apiserver ä¹‹åé€šä¿¡çš„æ—¶å€™ä½¿ç”¨çš„ mTLS è¯ä¹¦](https://nolebase.ayaka.io/ç¬”è®°/ğŸ§± åŸºç¡€è®¾æ–½/ğŸš¢ Kubernetes/å¦‚ä½•å¼€å‘å’Œæµ‹è¯• Clusterpedia.html#å‡†å¤‡-apiserver-ä¹‹åé€šä¿¡çš„æ—¶å€™ä½¿ç”¨çš„-mtls-è¯ä¹¦)æ­¥éª¤ä¸­ç»™ `openssl` ä¼ é€’çš„å‚æ•° `-passout pass:password` çš„ `password` å­—é¢é‡ã€‚

![image-20231231011603632](E:\WWW\dev-deploy\kubernetes\clustrepedia\å¼€å‘ç¯å¢ƒæ­å»º.assets\image-20231231011603632.png)

æ¥ä¸‹æ¥æ–°å»ºä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”å¡«å†™ä¸Šæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ `curl` å»æµ‹è¯•çš„æ—¶å€™è¯·æ±‚çš„ä¸€æ¨¡ä¸€æ ·çš„ URL å»å‘é€ GET è¯·æ±‚ä¹‹åå°±èƒ½çœ‹åˆ°è¿”å›å€¼äº†ï¼š

![image-20231231011623277](E:\WWW\dev-deploy\kubernetes\clustrepedia\å¼€å‘ç¯å¢ƒæ­å»º.assets\image-20231231011623277.png)

#### 7.4 CentOS/RedHatç¯å¢ƒè°ƒè¯•

1ã€åœ¨MacOSä¸­è°ƒè¯•æ²¡é—®é¢˜ï¼Œä½†æ˜¯åœ¨CentOS/RedHatä¸­è°ƒè¯•ä¼šæŠ¥è¯ä¹¦å¼‚å¸¸é—®é¢˜ï¼Œå¾—æ¢ä¸€ä¸ªæ–¹å¼

```shell
[root@centos7 clusterpedia]# curl -fv -k --cert-type P12 --cert ./client.p12:password https://127.0.0.1:8443/apis/clusterpedia.io/v1beta1/resources/version
* About to connect() to 127.0.0.1 port 8443 (#0)
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 8443 (#0)
* Initializing NSS with certpath: sql:/etc/pki/nssdb
* unable to load client cert: -8018 (SEC_ERROR_UNKNOWN_PKCS11_ERROR)
* NSS error -8018 (SEC_ERROR_UNKNOWN_PKCS11_ERROR)
* Unknown PKCS #11 error.
* Closing connection 0
curl: (58) unable to load client cert: -8018 (SEC_ERROR_UNKNOWN_PKCS11_ERROR)
```

2ã€å¦‚æœæ˜¯è™šæ‹Ÿæœºæ–¹å¼çš„è¯ï¼Œéœ€è¦æ³¨æ„ä¸‹**é˜²ç«å¢™**æ˜¯å¦æ‰“å¼€8443ç«¯å£ï¼Œå¦åˆ™å¤–éƒ¨/Postmanæ— æ³•è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„8443ç«¯å£



**å°†.p12æ–‡ä»¶è½¬æ¢ä¸ºå¯†é’¥å’Œcert .pemæ–‡ä»¶ï¼š**

```shell
openssl pkcs12 -in client.p12 -out key.pem -nodes -passin pass:password
openssl pkcs12 -in client.p12 -out cert.pem -nokeys -passin pass:password
```

curlè°ƒè¯•å‘½ä»¤

```shell
curl -k --cert ./cert.pem --key ./key.pem -v https://localhost:8443/apis/clusterpedia.io/v1beta1/resources/version

curl -k --cert ./cert.pem --key ./key.pem -v \
https://localhost:8443/apis/clusterpedia.io/v1beta1/resources/apis/apps/v1/deployments?limit=10\&continue=5
```



Postmané¡µé¢ï¼šä½¿ç”¨ä¹‹å‰çš„client.p12è¯ä¹¦æ–¹å¼å’Œä¸‹é¢çš„pemè¯ä¹¦æ–¹å¼éƒ½å¯ä»¥æ­£å¸¸è®¿é—®

![image-20231231012825547](E:\WWW\dev-deploy\kubernetes\clustrepedia\å¼€å‘ç¯å¢ƒæ­å»º.assets\image-20231231012825547.png)



![image-20231231012848078](E:\WWW\dev-deploy\kubernetes\clustrepedia\å¼€å‘ç¯å¢ƒæ­å»º.assets\image-20231231012848078.png)

#### 7.5 ä½¿ç”¨Tokenè°ƒè¯•

> ClusterPediaå·²åœ¨nsã€clusterpedia-systemã€‘åˆ›å»ºäº†saå’Œsecretï¼Œåªéœ€è¦å°†saç»‘å®šè‡³ClusterRole/cluster-adminå³å¯è®¿é—®ã€‚

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: clusterpedia-system:admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: default
  namespace: clusterpedia-system
```

æŸ¥çœ‹è·Ÿclusterpedia-system/saå…³è”çš„secretçš„token

> tokenå­—æ®µå³ä¸ºtokenï¼Œæ— éœ€é¢å¤–çš„base64è§£ç å³å¯ä½¿ç”¨ã€‚

```shell
[root@centos7 ~]# kubectl describe secret -n clusterpedia-system default-token-h2g2w
Name:         default-token-h2g2w
Namespace:    clusterpedia-system

token:      eyJhbGciOiJSUzI1NiIsImtpZCI6Im84YnlZVDRuVHZ......
```

è®¾ç½®ä½¿ç”¨Bearer Tokenæ–¹å¼è®¤è¯ï¼Œè¾“å…¥tokenå³å¯è®¿é—®

![image-20240129235116614](E:\WWW\dev-deploy\kubernetes\clustrepedia\å¼€å‘ç¯å¢ƒæ­å»º.assets\image-20240129235116614.png)

### å‚è€ƒ

- [å¦‚ä½•å¼€å‘å’Œæµ‹è¯• Clusterpedia](https://nolebase.ayaka.io/%E7%AC%94%E8%AE%B0/%F0%9F%A7%B1%20%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/%F0%9F%9A%A2%20Kubernetes/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%92%8C%E6%B5%8B%E8%AF%95%20Clusterpedia.html)
- [å¦‚ä½•å¼€å‘å’Œæµ‹è¯• Clusterpedia](https://nolebase.ayaka.io/%E7%AC%94%E8%AE%B0/%F0%9F%A7%B1%20%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/%F0%9F%9A%A2%20Kubernetes/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%92%8C%E6%B5%8B%E8%AF%95%20Clusterpedia.html#%E5%87%86%E5%A4%87-apiserver-%E4%B9%8B%E5%90%8E%E9%80%9A%E4%BF%A1%E7%9A%84%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E7%9A%84-mtls-%E8%AF%81%E4%B9%A6)
- [å…³äºphpï¼šcUrlæ— æ³•ä»æŒ‡å®šè·¯å¾„åŠ è½½pemè¯ä¹¦](https://www.codenong.com/46792775/)
- [ç»™è¿è¡Œä¸­çš„Dockerå®¹å™¨æ·»åŠ æ–°çš„ç«¯å£](https://blog.csdn.net/pillar04/article/details/131838636)